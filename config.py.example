"""
QBot 统一配置文件 (示例)

所有配置都在这里管理，包括：
- 全局配置
- 模块配置
- API 密钥
"""

# ========== 全局配置 ==========

# 调试模式
DEBUG_MODE = True  # True 显示日志，False 不显示

# 详细日志配置（控制业务日志）
VERBOSE_LOGGING = {
    "enabled": True,  # 总开关：True=打印详细日志， False =只打印基础日志
    "message_received": True,  # 接收到的消息
    "message_processing": True,  # 消息处理过程
    "module_handling": True,  # 模块处理日志
    "forward_logs": True,  # 转发日志
    "api_calls": True,  # API调用日志
}


# OneBot 服务器配置

ONEBOT_HOST = "0.0.0.0"
ONEBOT_PORT = 5670


# ========== 数据库配置 ==========

# 数据库文件路径
DATABASE_FILE = "messages.db"

# 自动清理配置
AUTO_CLEANUP_ENABLED = True  # 是否启用自动清理
CLEANUP_DAYS = 1  # 保留多少天的数据
CLEANUP_HOUR = 3  # 每天几点清理（24小时制）

# ========== API 配置 ==========

# ========== 淘宝配置区域 ==========
# 折淘客 API 配置
TAOBAO_CONFIG = {
    "app_key": "YOUR_APP_KEY",  # 你的折淘客 APP_KEY
    "sid": "YOUR_SID",  # 你的折淘客 SID
    "pid": "mm_XXXXXX_XXXXXX_XXXXXX",  # 你的淘宝联盟 PID
    "relation_id": "YOUR_RELATION_ID",  # 你的渠道 ID
}


# ========== 京东配置区域 ==========
# 折京客 API 配置
JINGDONG_CONFIG = {
    "appkey": "YOUR_APPKEY",  # 你的折京客 APPKEY
    "union_id": "YOUR_UNION_ID",  # 你的京东联盟 ID
    "position_id": "YOUR_POSITION_ID",  # 你的推广位 ID
}

# 京推推 API 配置（口令转链）
JINGTUITUI_CONFIG = {
    "appid": "YOUR_APPID",  # 你的京推推 APPID
    "appkey": "YOUR_APPKEY",  # 你的京推推 APPKEY
}

# 京东短链转换配置
JD_DWZ_CONFIG = {
    # 如果 Sign 服务运行在 Docker 宿主机上，请使用宿主机局域网 IP
    "sign_url": "http://192.168.8.107:3001/sign",
    
    # 京东 Cookie 配置（用于短链转换 API 鉴权）
    # 填入包含 pt_key 和 pt_pin 的 Cookie 字符串
    "cookie": "pt_key=YOUR_KEY; pt_pin=YOUR_PIN;"
}

# 兼容旧代码（可选，根据需要保留）
JD_SIGN_URL = JD_DWZ_CONFIG["sign_url"]
JD_COOKIE = JD_DWZ_CONFIG["cookie"]

# ========== 通知配置 ==========

# 通知渠道配置(全局共享,可被多个模块使用)
NOTIFICATION_CONFIG = {
    # 邮件通知
    "email": {
        "enabled": False,
        "smtp_host": "smtp.qq.com",
        "smtp_port": 465,
        "smtp_user": "your_email@qq.com",
        "smtp_password": "your_smtp_password",
        "from_addr": "your_email@qq.com",
        "to_addrs": ["admin@example.com"]
    },
    
    # Webhook通知(通用HTTP POST)
    "webhook": {
        "enabled": False,
        "url": "https://your-webhook-url.com/notify",
        "method": "POST",
        "headers": {
            "Content-Type": "application/json"
        }
    },
    
    # 钉钉机器人
    "dingtalk": {
        "enabled": False,
        "webhook_url": "https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN",
        "secret": ""  # 可选,如果启用了加签
    },
    
    # Telegram Bot
    "telegram": {
        "enabled": False,
        "bot_token": "YOUR_BOT_TOKEN",
        "chat_id": "YOUR_CHAT_ID",
        # 反代 API (可选,用于国内网络访问)
        "api_base_url": "https://api.telegram.org",  # 例如: "https://api.telegram.org" 或自建反代
        # SOCKS5 代理 (可选,二选一)
        "proxy": {
            "enabled": False,
            "proxy_url": "socks5://127.0.0.1:1080",
            "username": "",
            "password": ""
        }
    }
}

# ========== 机器人管理区域 ==========
# 机器人联动配置

# 机器人优先级配置（全局共享）
# 列表顺序即为优先级,排在前面的优先级更高
# 适用于：返利响应、群管理指令响应
# 只有优先级最高的在线机器人会执行操作
BOT_PRIORITY = [12345678, 87654321]  # 按优先级排序

# ========== 线报系统配置 ==========

# 线报收集配置
NEWS_COLLECTOR_CONFIG = {
    "enabled": True,
    "priority": 30,
    "settings": {
        # 收集器配置
        "collectors": [
            {
                "name": "京东线报收集",
                "type": "jd",
                "groups": [12345678, 87654321],  # 监听这些群的京东线报
            }
        ],
        # 去重配置（性能优先）
        "dedup_window_seconds": 40,  # 40秒去重窗口
        "dedup_by": "item_id",       # 根据商品ID去重
        "dedup_method": "memory",    # 纯内存模式（极速）
        "auto_cleanup": True,        # 自动清理过期数据
        "cleanup_interval": 60,      # 清理间隔（秒）
        "async_db_write": True,      # 异步写入数据库（不阻塞）
    }
}

# 线报转发配置
NEWS_FORWARDER_CONFIG = {
    "enabled": True,
    "priority": 35,
    "settings": {
        # 转发账号配置（与收集账号独立）
        # 支持两种格式：
        # 1. "qq": 单个QQ号 - 只用这个QQ转发
        # 2. "qq": [QQ1, QQ2, QQ3] - 多个QQ轮流转发，自动跳过离线的
        "forwarders": [
            {
                "qq": [12345678, 87654321],        # 多个QQ轮流转发（替换为实际QQ号）多个qq用, 隔开
                # 或者单个QQ：
                # "qq": 777777,                # 单个QQ转发
                "targets": [11223344],   # 转发到这些群（替换为实际群号）多个群用, 隔开
            },
        ],
        # 转发策略
        "forward_mode": "round_robin",  # 轮流模式：round_robin | random | all
        "forward_interval": 0,          # 转发间隔（秒），0=立即转发
        "batch_size": 1,                # 单条转发（实时性优先）
        "auto_forward": True,           # 自动转发开关
        "async_forward": True,          # 异步转发（不等待响应）
    }
}


# ========== 模块配置 ==========

# 指令模块配置
COMMANDS_MODULE_CONFIG = {
    "enabled": True,
    "priority": 10,
    "settings": {
        "auto_recall_delay": 5,
        "max_retry_attempts": 3,
    }
}


REBATE_MODULE_CONFIG = {
    "enabled": True,
    "priority": 20,
    "settings": {

        # ===== 1. 监听群配置 =====
        # 只有这些群的消息才会触发返利转换
        "watched_groups": [12345678],  # 返利群号
        
        # ===== 2. 管理员配置 =====
        # 管理员QQ列表（这些QQ的私聊会显示佣金）
        "admin_qq_list": [123456],
        
        # 管理员群列表（这些群的所有人都会看到佣金）
        "admin_group_list": [12345678],
        
        # ===== 3. 佣金显示规则 =====
        "commission_display": {
            "show_in_admin_group": True,      # 管理员群显示佣金（所有人可见）
            "show_in_private_admin": True,    # 管理员私聊显示佣金
            "show_in_private_user": False,    # 普通用户私聊不显示佣金
            "show_in_other_group": False,     # 非管理员群不显示佣金
        },
    },
    
    # ===== 4. API配置（在settings外层）=====
    "淘宝API": TAOBAO_CONFIG,
    "京东API": JINGDONG_CONFIG,
    "京推推API": JINGTUITUI_CONFIG,
}

# 天气模块配置（示例）
WEATHER_MODULE_CONFIG = {
    "enabled": False,  # 默认禁用
    "priority": 50,
    "settings": {
        "api_key": "",  # 天气API密钥
        "default_city": "北京",
    }
}

# 二维码模块配置（示例）
QRCODE_MODULE_CONFIG = {
    "enabled": False,  # 默认禁用
    "priority": 60,
    "settings": {
        "output_dir": "qrcodes",
    }
}

# 群管理模块配置
GROUP_ADMIN_CONFIG = {
    "enabled": True,
    "priority": 15,  # 高优先级，在返利模块之前
    "settings": {
        # 监听群列表
        "watched_groups": [12345678],  # 需要配置实际的群号
        
        # 管理员QQ列表（只有这些QQ可以使用群管理功能）
        "admin_qq_list": [123456],  # 需要配置实际的管理员QQ
    }
}


# 离线通知模块配置
OFFLINE_NOTIFIER_CONFIG = {
    "enabled": True,
    "priority": 5,
    "settings": {
        # 监测的机器人QQ列表(留空则监测所有机器人)
        "monitored_bots": [],  # 例如: [12345678, 87654321]
        
        # 检测间隔(秒)
        "check_interval": 30,
        
        # 通知开关
        "notify_offline": True,  # 是否发送离线通知
        "notify_online": False,   # 是否发送上线通知
        
        # 通知内容模板
        "templates": {
            "offline": "⚠️ QBot 告警\n机器人 {bot_qq} 已离线\n时间: {time}",
            "online": "✅ QBot 通知\n机器人 {bot_qq} 已上线\n时间: {time}"
        }
    }
}


# ========== 模块配置映射 ==========
# 模块名 -> 配置字典
MODULE_CONFIGS = {
    "commands": COMMANDS_MODULE_CONFIG,
    "rebate": REBATE_MODULE_CONFIG,
    "weather": WEATHER_MODULE_CONFIG,
    "qrcode": QRCODE_MODULE_CONFIG,
    # 线报系统模块
    "news_collector": NEWS_COLLECTOR_CONFIG,
    "news_forwarder": NEWS_FORWARDER_CONFIG,
    # 群管理模块
    "group_admin": GROUP_ADMIN_CONFIG,
    # 离线通知模块
    "offline_notifier": OFFLINE_NOTIFIER_CONFIG,
}



# ========== 辅助函数 ==========

def get_bot_qq_list() -> list:
    """
    获取所有机器人QQ号列表(用于防止机器人间互相回复造成循环)
    从NEWS_FORWARDER_CONFIG的forwarders配置中提取
    
    Returns:
        机器人QQ号列表
    """
    bot_qq_set = set()
    forwarders = NEWS_FORWARDER_CONFIG.get("settings", {}).get("forwarders", [])
    
    for forwarder in forwarders:
        qq = forwarder.get("qq")
        if isinstance(qq, list):
            bot_qq_set.update(qq)
        elif isinstance(qq, int):
            bot_qq_set.add(qq)
    
    return list(bot_qq_set)



def get_module_config(module_name: str) -> dict:
    """
    获取指定模块的配置
    
    Args:
        module_name: 模块名称（如 'commands', 'rebate'）
        
    Returns:
        模块配置字典
    """
    return MODULE_CONFIGS.get(module_name, {
        "enabled": False,
        "priority": 100,
        "settings": {}
    })

def is_module_enabled(module_name: str) -> bool:
    """
    检查模块是否启用
    
    Args:
        module_name: 模块名称
        
    Returns:
        是否启用
    """
    return MODULE_CONFIGS.get(module_name, {}).get("enabled", False)

# ========== 配置验证 ==========

def validate_config():
    """验证配置是否正确"""
    errors = []
    
    # 检查必填项
    if REBATE_MODULE_CONFIG["enabled"] and not REBATE_MODULE_CONFIG["settings"]["watched_groups"]:
        errors.append("返利模块已启用，但未配置监听群(watched_groups)")
    
    # 检查返利模块配置
    if REBATE_MODULE_CONFIG["enabled"]:
        if not TAOBAO_CONFIG["app_key"] and not JINGDONG_CONFIG["appkey"]:
            errors.append("返利模块已启用，但淘宝和京东API都未配置")
    
    if errors:
        print("⚠️ 配置警告:")
        for error in errors:
            print(f"  - {error}")
    else:
        print("✅ 配置验证通过")
    
    return len(errors) == 0

# 启动时验证配置
if __name__ == "__main__":
    validate_config()
