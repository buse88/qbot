# QBot - 模块化 QQ 群聊机器人

## 📦 这是什么？

这是 QBot 的**完整部署包**，包含所有必要的文件，可以直接推送到远程仓库并运行。

## 🚀 快速开始

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 配置
编辑 `config.py`，填入你的配置：
- 监控群号
- API 密钥（淘宝、京东）
- 其他设置

### 3. 运行
```bash
python main.py
```

## 📁 目录结构

```
start/
├── core/                   # 核心框架
│   ├── __init__.py
│   ├── base_module.py      # 模块基类
│   ├── module_loader.py    # 模块加载器
│   ├── event_bus.py        # 事件总线
│   └── database.py         # 数据库管理
│
├── modules/                # 功能模块
│   ├── group_admin/        # 群管理模块
│   ├── rebate/             # 返利模块
│   ├── news_taobao/        # 淘宝线报收集模块
│   ├── news_jd/            # 京东线报收集模块
│   ├── news_subscription/  # 线报订阅通知模块
│   └── offline_notifier/   # 离线通知模块
│
├── main.py                 # 主程序
├── config.py               # 配置文件
├── requirements.txt        # 依赖列表
└── README.md               # 本文档
```

## ⚙️ 配置说明

### config.py
```python
# 监控的群聊
WATCHED_GROUP_IDS = [你的群号]

# 淘宝客 API
APP_KEY = "你的APP_KEY"
SID = "你的SID"
PID = "你的PID"

# 京东联盟 API
JD_APPKEY = "你的APPKEY"
JD_UNION_ID = "你的UNION_ID"

# 京东短链转换配置
JD_DWZ_CONFIG = {
    "sign_url": "http://192.168.8.1:3001/sign",
    "cookie": ""  # 例如: "pt_key=xxx; pt_pin=xxx;"
}
```

## 📖 支持的功能

### 群管理模块（需管理员权限）

| 指令 | 说明 |
|------|------|
| `撤回全部` | 撤回群内所有消息 |
| `撤回 N` | 撤回最近 N 条机器人消息 |
| `@某人 撤回` | 撤回指定用户消息 |
| `撤回 <消息ID>` | 撤回指定 ID 的消息 |
| `dwz <京东链接>` | 将京东长链接转为短链接 |
| `time` | **所有人可用**，回复当前服务器时间（含星期） |

### 返利模块

自动识别消息中的淘宝/京东链接并转为推广返利链接：

- **淘宝**：支持 `s.tb.cn` 短链、`taobao.com`、`tmall.com` 等链接，以及 `￥xxx￥` 淘口令
  - 自动识别输入类型（URL/口令），调用正确的折淘客 API，不会出现参数错误
  - 返回：商品名、券后价、佣金、领券链接、领券口令、商品图
- **京东**：支持 `3.cn`、`jd.com`、`jingxi.com` 链接及京东口令
  - 自动将 `item.m.jd.com` 长链接转为 `3.cn` 短链接后再转链
  - 可选配京推推口令，支持京东口令格式输出

### 淘宝线报模块

- 监听指定群内的淘宝链接/口令，自动转为推广链接后转发到目标群
- **去重策略（三层）**：
  1. 内存 token 去重（防止多 QQ 并发重复处理）
  2. 前缀文案去重
  3. 数据库商品级去重（`seller_id + coupon_id`，不同短链指向同一活动只处理一次）

### 线报订阅模块

关键词订阅，自动私聊通知匹配到的用户：

| 指令 | 说明 |
|------|------|
| `订阅 <关键词>` | 订阅关键词，如 `订阅 抽纸` |
| `订阅 0元` | 数字智能匹配（不会误报 60元） |
| `订阅 re:^手机` | 支持正则表达式 |
| `取消订阅 <关键词>` | 取消订阅 |
| `我的订阅` | 查看当前订阅列表 |
| `订阅清空` | 清空所有订阅 |
| `订阅暂停` / `订阅恢复` | 暂停或恢复通知 |

### 离线通知模块

- 监控机器人在线状态，断线秒级响应
- 支持邮件、Webhook、钉钉、Telegram 四种通知渠道
- 自动 QQ 号脱敏，上线/下线独立开关

## 📝 更新日志

### v2.4.0 (2026-02-23)
- ✅ 新增 `time` 指令：所有用户发送即可查询服务器当前时间（含星期）
- ✅ 返利模块淘宝转链优化：自动识别 URL/口令，选择正确 API，修复双重 URL 编码问题
- ✅ 淘宝线报去重升级：改用 `seller_id + coupon_id` 内容级去重，解决不同短链同一商品重复推送
- ✅ 订阅指令词从"推送"统一改为"订阅"（`订阅`、`取消订阅`、`我的订阅`等）
- ✅ Bot 在线状态保活优化：任意事件 self_id 均可触发自动注册，防止 lifecycle 丢失导致误判离线

### v2.3.0 (2026-02-13)
- ✅ 修复"撤回 N"指令：从最新往前遍历累计 bot 消息数，跳过其他用户消息
- ✅ 调整消息 ID 与数量分界阈值至 100000，修复"撤回 100"被误判为 message_id
- ✅ DEBUG 模式输出完整 API URL（含所有参数），便于排查转链问题

### v2.2.0 (2026-02-12)
- ✅ 新增线报订阅模块（支持关键词订阅/正则/智能匹配）
- ✅ 优化多机器人并发执行逻辑（优先级控制）
- ✅ 修复自动撤回与重复回复问题

### v2.1.0 (2026-02-09)
- ✅ 新增离线通知模块（支持 Webhook/钉钉/TG/邮件）
- ✅ 优化 config.py 全局配置结构

### v2.0.0 (2026-02-08)
- ✅ 模块化架构重构
- ✅ 核心框架实现
- ✅ 指令模块、返利模块

## 📄 许可证

本项目仅供学习和研究使用。
